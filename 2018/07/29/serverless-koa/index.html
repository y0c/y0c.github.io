<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Serverless Koa기반 Api Server 배포하기 | Lazy Developer</title><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/highlights/dracula.css"><link rel="canonical" href="https://y0c.github.io/2018/07/29/serverless-koa/">
<meta name="description" content="이 포스팅에선 aws lambda와 serverless framework를 통해서 koa 기반의 api server를 배포하는 것에 대해 소개하려한다.전체적인 배포 과정을 나열하기보다는 간략한 소개와 boilerplate로 어떤식으로 접근하는지에…">
<meta name="keywords" content="serverless,serverless-http,koa">
<meta property="og:type" content="article">
<meta property="og:title" content="Serverless Koa기반 Api Server 배포하기">
<meta property="og:url" content="https://y0c.github.io/2018/07/29/serverless-koa/">
<meta property="og:site_name" content="Lazy Developer">
<meta property="og:description" content="이 포스팅에선 aws lambda와 serverless framework를 통해서 koa 기반의 api server를 배포하는 것에 대해 소개하려한다.전체적인 배포 과정을 나열하기보다는 간략한 소개와 boilerplate로 어떤식으로 접근하는지에…">
<meta property="og:image" content="https://y0c.github.io/images/serverless.png">
<meta property="og:updated_time" content="2018-09-09T21:35:17.884Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serverless Koa기반 Api Server 배포하기">
<meta name="twitter:description" content="이 포스팅에선 aws lambda와 serverless framework를 통해서 koa 기반의 api server를 배포하는 것에 대해 소개하려한다.전체적인 배포 과정을 나열하기보다는 간략한 소개와 boilerplate로 어떤식으로 접근하는지에…">
<meta name="twitter:image" content="https://y0c.github.io/images/serverless.png"><meta property="article:author" content="HoSung"><meta property="twitter:label1" content="Published at"><meta property="twitter:data1" content="2018-07-29 00:37:00"><meta property="twitter:label2" content="Written by"><meta property="twitter:data2" content="HoSung"><link rel="icon" href="/images/logo.svg"><link rel="alternate" href="/atom.xml" type="application/atom+xml" title="Lazy Developer"><script>(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-112029921-1', 'auto');
ga('send', 'pageview');</script></head><body itemscope="" itemtype="https://schema.org/WebPage"><nav class="menu" id="menu"><div class="menu-inner"><div class="menu__left-area"><div class="menu__item"><a class="menu__item__link menu__item__link--brand" href="/" title="Home" rel="home"><img class="menu__item__link--brand__image" src="/images/logo.svg" alt="Lazy Developer"><span class="menu__item__link--brand__label">Lazy Developer</span></a></div></div><div class="menu__right-area"><div class="menu__item"><a class="menu__item__link" href="/">Home</a></div><div class="menu__item"><a class="menu__item__link" href="/about">About</a></div><div class="menu__item"><a class="menu__item__link" href="/archives">Archives</a></div></div></div></nav><div class="page-background"></div><div class="content-container"><div class="content-outer"><div class="content-inner" itemscope="" itemtype="https://schema.org/Blog"><article class="article" id="article" itemscope="" itemtype="https://schema.org/BlogPosting"><h1 class="article__title" itemprop="headline">Serverless Koa기반 Api Server 배포하기</h1><div class="article__meta"><time class="article__meta__time" datetime="2018-07-28T15:37:00.000Z" itemprop="datePublished">2018-07-29 00:37:00</time><div class="article__meta__categories"><a class="article__meta__categories__item" href="/categories/serverless/">serverless</a></div></div><div class="article__contents"><img src="/images/serverless.png"><p>이 포스팅에선 aws lambda와 serverless framework를 통해서 koa 기반의 api server를 배포하는 것에 대해 소개하려한다.<br>전체적인 배포 과정을 나열하기보다는 간략한 소개와 boilerplate로 어떤식으로 접근하는지에 중점을 두었다. </p>
<p>필자가 처음 lambda를 접했을땐 토픽별 기능(크롤링, 이미지처리) 이나 AWS와 연계된 서비스에서 모니터링 혹은 알림 같은 곳에 사용할때 유용한 정도로만 생각하고 있었다.<br>lambda에서는 node.js, phtyon, java 등과 같은 여러가지 언어를 제공하고 있지만<br>실제로 api server를 통째로 lambda를 이용하기엔 오히려 불편한점이 꽤 많아 보였기 때문이다. </p>
<p>아래 코드는 AWS lambda 에서 제공하는  nodejs 예시 코드이다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exports.myHandler = <span class="function"><span class="keyword">function</span>(<span class="params">event, context, callback</span>) </span>&#123;</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">"value1 = "</span> + event.key1);</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">"value2 = "</span> + event.key2);  </span><br><span class="line">   callback(<span class="literal">null</span>, <span class="string">"some success message"</span>);</span><br><span class="line">   <span class="comment">// or </span></span><br><span class="line">   <span class="comment">// callback("some error type"); </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>위 코드가 하나의 function 즉 endpoint가 된다.<br>단순한 하나의 function 이 아닌 api server를 개발하려면 수 많은 lambda function을 만들어야하기 떄문에 구조가 굉장히 난해해 보였다. </p>
<p>지금껏 express, koa, hapi 와 같은 프레임워크를 통해 backend 개발을 해왔다면  위구조에서 어떤식으로 사용해야될지 잘 감이 오지 않을것이다. </p>
<p>최근에 지인을 통해 serverless-http 모듈에 대해 듣고 잠시 접해볼기회가 있었는데<br>serverless-http는 lambda에 대한 약간의 이해만 있으면 기존에 express나 koa를 통해서 API를 쉽게 Wrap해서 배포할 수 있게된다.<br>실제로 사용해본 경험으론 serverless-http를 사용하게되면 간단한 설치와 몇라인으로 wrapping 할 수 있었다.<br>모듈에대한 자세한 설명은 해당 Repo를 참고하도록 하자.<br><a href="https://github.com/dougmoscrop/serverless-http" rel="external nofollow noopener noreferrer" target="_blank">GitHub - dougmoscrop/serverless-http: Use your existing middleware framework (e.g. Express, Koa) in AWS Lambda 🎉</a></p>
<p>이제 본격적으로  koa 기반 api-server 를 lambda에 배포하는 작업을 해보자.<br>이 작업을 하기위해선 AWS계정과 Serverless 계정이 필요하다.<br><a href="https://serverless.com/" rel="external nofollow noopener noreferrer" target="_blank">Serverless - The Serverless Application Framework powered by AWS Lambda, API Gateway, and more</a><br><a href="https://aws.amazon.com/ko/" rel="external nofollow noopener noreferrer" target="_blank">https://aws.amazon.com/ko/</a></p>
<p>AWS는 계정을 만든후  IAM을 통해 user를 만든후 <code>access_key</code> 와 <code>secret_key</code>가 필요하다. 이 과정에 대해선 아래 글에 자세히 설명되있으니 참조하도록 하자.<br><a href="https://github.com/serverless/serverless/blob/master/docs/providers/aws/guide/credentials.md" rel="external nofollow noopener noreferrer" target="_blank">serverless/credentials.md at master · serverless/serverless · GitHub</a></p>
<p>먼저, serverless 를 설치한다.<br><code>npm install -g serverless</code></p>
<p>아래 명령어는 aws nodejs용 템플릿을 만들어주는데 틀을 보고 필요한 부분은 찾아서 작성하도록한다.<br><code>serverless create -t aws-nodejs</code> </p>
<p>koa기반 app 을 배포할것이기 때문에 serverless-http 모듈도 설치하도록 하자.<br><code>npm install serverless-http</code> </p>
<p>여기까지 됬다면  기본적인 앱을 배포하는데 기본적인 준비가 끝난 것이다.<br>기존 koa app을 개발하는 구조와 동일하게 사용하여도 무방하다.<br>serverless 배포를 위해 작성해야될 코드는 아래가 전부이다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> serverless <span class="keyword">from</span> <span class="string">'serverless-http'</span>;</span><br><span class="line"><span class="keyword">import</span> app <span class="keyword">from</span> <span class="string">'app'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handler는 serverless yml 파일에서 지정해준 이름을 사용하여야한다. </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> handler = serverless(app);</span><br></pre></td></tr></table></figure></p>
<p>app을 배포할때는 <code>sls deploy —stage &lt;stage_name&gt;</code> 을 통해서 배포할 수 있다. </p>
<p>사용해본 후기로 생각보다 간단하게 koa 혹은 express app을 lambda로 배포할 수 있었다. 앞으로도 간단한 api server 를 구성할때 자주 사용하게 될 것 같다. </p>
<p>express 기반 boilerplate는 검색하면 바로나오는 편인데 koa 관련해서는 boilerplate가 적당한게 보이지않아서 연습하면서 간단하게 boilerplate를 구성해보았다.  </p>
<p><a href="https://github.com/y0c/serverless-koa-boilerplate" rel="external nofollow noopener noreferrer" target="_blank">GitHub - y0c/serverless-koa-boilerplate: Serverless-http with Koa Boilerplate</a></p>
<p>ES6/7 Syntax를 사용할 수 있도록 babel 과 serverless-webpack 관련 설정을 추가된 boilerplate 이다. </p>
</div><div class="article__tags"><a class="article__tags__item" href="/tags/serverless/">serverless</a><a class="article__tags__item" href="/tags/serverless-http/">serverless-http</a><a class="article__tags__item" href="/tags/koa/">koa</a></div><div class="article__author" itemscope="" itemprop="author" itemtype="https://schema.org/Person"><img class="article__author__image" src="/images/profile.jpg" alt="HoSung"><a class="article__author__link" title="About HoSung" rel="author">HoSung</a><p class="article__author__desc">Web Developer &amp; Student</p><div class="article__author__socials"><a class="article__author__socials__item" href="http://github.com/y0c" title="github" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa fa-github"></i></a><a class="article__author__socials__item" href="/atom.xml" title="rss" target="_blank"><i class="fa fa-rss"></i></a></div><meta itemprop="name" content="HoSung"></div><div class="sharer" id="sharer"><div class="sharer-inner"><div class="sharer__right"><button class="sharer__item" id="sharer-facebook"><i class="fa fa-facebook-official"></i></button><button class="sharer__item" id="sharer-twitter"><i class="fa fa-twitter"></i></button><button class="sharer__item" id="sharer-pinterest"><i class="fa fa-pinterest"></i></button><button class="sharer__item" id="sharer-pocket"><i class="fa fa-get-pocket"></i></button></div></div></div><!-- Disqus Code--><div id="disqus_thread"></div><script>(function() {
  var d = document, s = d.createElement('script');
  s.src = '//lazy-developer.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Enable JavaScript to see comments.</noscript><!-- Meta Tags for Structured Data--><meta itemprop="dateModified" content="2018-09-09T21:35:17.884Z"><meta itemprop="articleBody" content="이 포스팅에선 aws lambda와 serverless framework를 통해서 koa 기반의 api server를 배포하는 것에 대해 소개하려한다.전체적인 배포 과정을 나열하기보다는 간략한 소개와 boilerplate로 어떤식으로 접근하는지에 중점을 두었다. 
필자가 처음 lambda를 접했을땐 토픽별 기능(크롤링, 이미지처리) 이나 AWS와..."><meta itemprop="url" content="https://y0c.github.io/2018/07/29/serverless-koa/"><meta itemprop="mainEntityOfPage" content="https://y0c.github.io/2018/07/29/serverless-koa/"><div itemscope="" itemtype="https://schema.org/Organization" itemprop="publisher"><meta itemprop="name" content="Lazy Developer"><div itemscope="" itemprop="logo" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://y0c.github.io/images/logo.svg"></div></div><div itemscope="" itemtype="https://schema.org/ImageObject" itemprop="image"><meta itemprop="contentUrl" content="https://y0c.github.io/images/serverless.png"><meta itemprop="url" content="https://y0c.github.io/images/serverless.png"><meta itemprop="width"><meta itemprop="height"></div></article></div></div></div><footer id="footer"><div class="widgets"><div class="widgets-inner"><!-- Jade doesn't support dynamic inclusion with `each`.--><!-- So, I just hard coded the file names that will be included.--><div class="widgets__item"><h3 class="widgets__item__heading">Recent posts</h3><ul class="recent-posts"><li class="recent-posts__item"><a href="/2018/10/21/redis-cluster/">Redis Cluster 구축하기</a></li><li class="recent-posts__item"><a href="/2018/10/20/Docker-Private-Registry/">Docker Private Registry 구축하기</a></li><li class="recent-posts__item"><a href="/2018/09/28/centos7-mail-server/">CentOS 7 Mail Server 구축하기 Postfix + Dovecot</a></li><li class="recent-posts__item"><a href="/2018/09/27/tmux-tutorial/">Tmux Tutorial 정리</a></li><li class="recent-posts__item"><a href="/2018/09/10/semantic-ui-react-theme/">Semantic-Ui-React Theme Customizing</a></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Archives</h3><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">2</span></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Categories</h3><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/">Javascript</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tmux/">Tmux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/serverless/">serverless</a><span class="category-list-count">1</span></li></ul></div></div></div><p class="copyright"><small>© 2018 HoSung<br>Powered by <a href="https://hexo.io" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a>, Theme by <a href="https://github.com/hyunseob" rel="external nofollow noopener noreferrer" target="_blank">HyunSeob</a></small></p></footer><script src="/js/sharer.min.js"></script></body></html>