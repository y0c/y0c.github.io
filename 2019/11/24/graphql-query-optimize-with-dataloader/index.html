<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>GrpahQL DataLoaderë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™” | y0c</title><link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/highlights/dracula.css"><link rel="canonical" href="https://y0c.github.io/2019/11/24/graphql-query-optimize-with-dataloader/">
<meta name="description" content="ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤. N+1 ë¬¸ì œN+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œâ€¦">
<meta property="og:type" content="article">
<meta property="og:title" content="GrpahQL DataLoaderë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™”">
<meta property="og:url" content="https://y0c.github.io/2019/11/24/graphql-query-optimize-with-dataloader/">
<meta property="og:site_name" content="y0c">
<meta property="og:description" content="ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤. N+1 ë¬¸ì œN+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œâ€¦">
<meta property="og:image" content="https://y0c.github.io/images/">
<meta property="og:updated_time" content="2019-11-24T14:39:33.303Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GrpahQL DataLoaderë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™”">
<meta name="twitter:description" content="ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤. N+1 ë¬¸ì œN+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œâ€¦">
<meta name="twitter:image" content="https://y0c.github.io/images/"><meta property="article:author" content="hosung"><meta property="twitter:label1" content="Published at"><meta property="twitter:data1" content="2019-11-24 19:23:15"><meta property="twitter:label2" content="Written by"><meta property="twitter:data2" content="hosung"><link rel="icon" href="/images/logo.png"><link rel="alternate" href="/feed.xml" type="application/atom+xml" title="y0c"><script>(function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-112029921-1', 'auto');
ga('send', 'pageview');</script></head><body itemscope="" itemtype="https://schema.org/WebPage"><nav class="menu" id="menu"><div class="menu-inner"><div class="menu__left-area"><div class="menu__item"><a class="menu__item__link menu__item__link--brand" href="/" title="Home" rel="home"><img class="menu__item__link--brand__image" src="/images/logo.png" alt="y0c"><span class="menu__item__link--brand__label">y0c</span></a></div></div><div class="menu__right-area"><div class="menu__item"><a class="menu__item__link" href="/">Home</a></div><div class="menu__item"><a class="menu__item__link" href="/archives">Archives</a></div></div></div></nav><div class="page-background"></div><div class="content-container"><div class="content-outer"><div class="content-inner" itemscope="" itemtype="https://schema.org/Blog"><article class="article" id="article" itemscope="" itemtype="https://schema.org/BlogPosting"><h1 class="article__title" itemprop="headline">GrpahQL DataLoaderë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™”</h1><div class="article__meta"><time class="article__meta__time" datetime="2019-11-24T10:23:15.000Z" itemprop="datePublished">2019-11-24 19:23:15</time><div class="article__meta__categories"><a class="article__meta__categories__item" href="/categories/graphql/">graphql</a></div></div><div class="article__contents"><img src="/images/"><p>ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤.</p>
<h2 id="N-1-ë¬¸ì œ"><a href="#N-1-ë¬¸ì œ" class="headerlink" title="N+1 ë¬¸ì œ"></a>N+1 ë¬¸ì œ</h2><p>N+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œ ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œì´ë‹¤.</p>
<p><code>Post</code> ì—”í‹°í‹°ì™€ <code>Comment</code> ì—”í‹°í‹°ê°€ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì. ì´ ì—”í‹°í‹°ê°„ì˜ ê´€ê³„ëŠ” <code>1:N</code>ìœ¼ë¡œ ì •ì˜í•  ìˆ˜ ìˆë‹¤. Post ëª©ë¡ê³¼ postì— í•´ë‹¹í•˜ëŠ” commentsë¥¼ ì¡°íšŒí•˜ë ¤ í•œë‹¤ë©´ comment entityê°€ lazy loadingë˜ë©´ì„œ N(ê°ê°ì˜ comments ì¡°íšŒ) + 1(post ì¡°íšŒ) ë§Œí¼ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì„œ N+1 ë¬¸ì œë¼ê³  ë¶€ë¥¸ë‹¤.</p>
<p>í•´ê²°ë°©ë²•ìœ¼ë¡œëŠ” lazy loadingì„ í•˜ëŠ” ëŒ€ì‹  ë¯¸ë¦¬ JOIN ì—°ì‚°ì„ í†µí•´ fetchí•˜ëŠ” ë°©ë²•ì„ ìƒê°í•  ìˆ˜ ìˆë‹¤. ì—¬ê¸°ì— ëŒ€í•œ ë°©ë²•ì€ ORM ë§ˆë‹¤ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆë‹¤.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TypeORM example</span></span><br><span class="line"><span class="comment">// lazy</span></span><br><span class="line"><span class="keyword">const</span> posts = <span class="keyword">await</span> Post.find(&#123;&#125;)</span><br><span class="line"><span class="keyword">const</span> comments = <span class="keyword">await</span> <span class="built_in">Promise</span>.all(posts.map(<span class="keyword">async</span> (p) =&gt; &#123;</span><br><span class="line">  <span class="comment">// TypeORMì—ì„œ lazy relation ê²½ìš° p.comments ëŠ” promise array ì´ë‹¤.</span></span><br><span class="line">  <span class="keyword">const</span> comments = <span class="keyword">await</span> p.comments</span><br><span class="line">  <span class="keyword">return</span> comments</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// eager</span></span><br><span class="line"><span class="keyword">const</span> posts = <span class="keyword">await</span> Post.find(&#123; relations: [ <span class="string">'comments'</span> ] &#125;)</span><br></pre></td></tr></table></figure>
<h2 id="GraphQL-ì—ì„œì˜-N-1-ë¬¸ì œ"><a href="#GraphQL-ì—ì„œì˜-N-1-ë¬¸ì œ" class="headerlink" title="GraphQL ì—ì„œì˜ N+1 ë¬¸ì œ"></a>GraphQL ì—ì„œì˜ N+1 ë¬¸ì œ</h2><p>GrpahQLì—ì„œ ë°œìƒí•˜ëŠ” N+1ë¬¸ì œë„ ìœ„ì™€ ë¹„ìŠ·í•˜ë‹¤.<br>ìœ„ì—ì„œì˜ ì—”í‹°í‹°ê´€ê³„ë¥¼ GraphQL SDLë¡œ ì‘ì„±í•˜ë©´ ì•„ë˜ì™€ ê°™ë‹¤.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">type Post &#123;</span><br><span class="line">  id: Int!</span><br><span class="line">  title: String!</span><br><span class="line">  content: String!</span><br><span class="line">  comments: [Comment!]!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Comment &#123;</span><br><span class="line">  id: Int!</span><br><span class="line">  content: String!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Query &#123;</span><br><span class="line">  posts: [Post!]!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>post ëª©ë¡ê³¼ comments ë¥¼ ê°€ì ¸ì˜¤ëŠ” queryë¥¼ ì‘ì„±í•´ë³´ì.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query &#123;</span><br><span class="line">  posts &#123;  # posts query (1)</span><br><span class="line">    id</span><br><span class="line">    title</span><br><span class="line">    content</span><br><span class="line">    comments &#123; # comments query (N) -&gt; Post ê°œìˆ˜ë§Œí¼</span><br><span class="line">      id</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ìœ„ì™€ ê°™ì´ comments ë¶€ë¶„ì—ì„œ ì„±ëŠ¥ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤.<br>GraphQL ì—ì„œ resolverë¥¼ êµ¬ì„±í•˜ëŠ” ì „ëµì€ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆê² ì§€ë§Œ ë³´í†µ ë‹¤ë¥¸ typeê³¼ ê´€ê³„ê°€ ìˆëŠ” ê²½ìš° resolverë¥¼ ë¶„ë¦¬í•´ì„œ êµ¬í˜„í•˜ëŠ” ê²½ìš°ê°€ ë§ê¸° ë•Œë¬¸ì´ë‹¤.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> resolver = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    posts: <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> Post.find(&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  Post: &#123;</span><br><span class="line">    <span class="comment">// posts queryë¥¼ í˜¸ì¶œí• ê²½ìš° post ê°œìˆ˜(N) ë§Œí¼ í˜¸ì¶œëœë‹¤.</span></span><br><span class="line">    comments: <span class="keyword">async</span> (root) =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> Comment.find(&#123; <span class="attr">where</span>: &#123; <span class="attr">postId</span>: root.id &#125; &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ë¬¼ë¡  ì•„ë˜ì™€ ê°™ì´ posts resolverì—ì„œ dataë¥¼ join í•´ì„œ fetchí›„ì— return í•œë‹¤ë©´ N+1 ë¬¸ì œëŠ” ë°œìƒí•˜ì§€ ì•Šì„ ìˆ˜ ìˆë‹¤.<br><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> resovler = &#123;</span><br><span class="line">  Query: &#123;</span><br><span class="line">    posts: <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> posts = <span class="keyword">await</span> Post.find(&#123; relations: [<span class="string">'comments'</span>] &#125;)</span><br><span class="line">      <span class="keyword">return</span> posts</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">query &#123;</span></span><br><span class="line"><span class="comment">  posts &#123;</span></span><br><span class="line"><span class="comment">    id</span></span><br><span class="line"><span class="comment">    title</span></span><br><span class="line"><span class="comment">    content</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></p>
<p>í•˜ì§€ë§Œ ìœ„ì™€ ê°™ì´ resolverë¥¼ êµ¬í˜„í•œë‹¤ë©´ queryì—ì„œ comments field ë¥¼ ìš”ì²­í•˜ì§€ ì•Šì•„ë„ joiní•´ì„œ fetchí•´ì„œ dataë¥¼ ê°€ì ¸ì˜¤ê²Œëœë‹¤. clientì—ì„œ ë°›ëŠ” ë°ì´í„°ëŠ” over fetchingì´ ì¼ì–´ë‚˜ì§€ ì•Šì§€ë§Œ ì‹¤ì œ ë°ì´í„°ë¥¼ loadí•˜ëŠ” ê³³ì—ì„œëŠ” over fetchingì´ ì¼ì–´ë‚˜ê³  ìˆëŠ” ê²ƒì´ë‹¤.</p>
<h2 id="DataLoader"><a href="#DataLoader" class="headerlink" title="DataLoader"></a>DataLoader</h2><p>DataLoaderëŠ” data fetch í• ë•Œ ë‚˜íƒ€ë‚˜ëŠ” N+1 ë¬¸ì œë¥¼ batchingì„ í†µí•´ 1+1ë¡œ ë³€í™˜í•´ì£¼ëŠ” libraryì´ë‹¤.<br>ì£¼ë¡œ GrpahQL ì—ì„œ ë§ì´ ì‚¬ìš©ë˜ì§€ë§Œ GrpahQLì— ì–´ë–¤ ì˜ì¡´ì„±ì„ ê°€ì§€ê³  ìˆì§€ëŠ” ì•Šë‹¤.</p>
<h2 id="Batching"><a href="#Batching" class="headerlink" title="Batching"></a>Batching</h2><p>DataLoaderëŠ” javascriptì˜ event-loop ì„ ì´ìš©í•œë‹¤. ì£¼ìš”ê¸°ëŠ¥ì¸ batchingì€ event-loop ì¤‘ í•˜ë‚˜ì˜ tickì—ì„œ ì‹¤í–‰ëœ data fetchì— ëŒ€í•œ ìš”ì²­ì„ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ ëª¨ì•„ì„œ ì‹¤í–‰í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ì•Œë§ê²Œ ë¶„ë°°í•˜ëŠ” ì—­í• ì„ í•œë‹¤.</p>
<p>ì•„ë˜ ê°„ë‹¨í•œ ì˜ˆì œë¥¼ ë³´ì.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DataLoader = <span class="built_in">require</span>(<span class="string">'dataloader'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// fake data</span></span><br><span class="line"><span class="keyword">const</span> posts = [</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">title</span>: <span class="string">'test1'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">title</span>: <span class="string">'test2'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">title</span>: <span class="string">'test3'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">4</span>, <span class="attr">title</span>: <span class="string">'test4'</span> &#125;,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="number">5</span>, <span class="attr">title</span>: <span class="string">'test5'</span> &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// fake db operation</span></span><br><span class="line"><span class="keyword">const</span> findAllPosts = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(posts)</span><br><span class="line">  &#125;, <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// batchLoadFn ì˜ ê²°ê³¼ëŠ” promiseì—¬ì•¼ í•œë‹¤.</span></span><br><span class="line"><span class="keyword">const</span> batchLoadFn = <span class="keyword">async</span> (keys) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> findAllPosts()</span><br><span class="line">  <span class="built_in">console</span>.log(keys)</span><br><span class="line">  <span class="comment">// db ì—ì„œ ë°›ì•„ì˜¨ ê²°ê³¼ë¥¼ ìš”ì²­ì˜¨ keyì— mapping</span></span><br><span class="line">  <span class="keyword">return</span> keys.map(<span class="function"><span class="params">k</span> =&gt;</span> results.find(<span class="function"><span class="params">p</span> =&gt;</span> p.id === k))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postLoader = <span class="keyword">new</span> DataLoader(batchLoadFn)</span><br><span class="line"></span><br><span class="line"><span class="comment">// tick 1</span></span><br><span class="line">postLoader.load(<span class="number">1</span>).then(<span class="built_in">console</span>.log)</span><br><span class="line">postLoader.load(<span class="number">2</span>).then(<span class="built_in">console</span>.log)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// tick 2</span></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  postLoader.load(<span class="number">3</span>).then(<span class="built_in">console</span>.log)</span><br><span class="line">  postLoader.load(<span class="number">4</span>).then(<span class="built_in">console</span>.log)</span><br><span class="line">&#125;, <span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<p>DataLoaderì˜ constructorëŠ” batchìš”ì²­ì„ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ì— ëŒ€í•œ <code>batchLoadFn</code> ì„ ì¸ìë¡œ ë°›ëŠ”ë‹¤.<br>ì´ <code>batchLoadFn</code>ì˜ ì—­í• ì€ í•˜ë‚˜ì˜ tickì—ì„œ ë“¤ì–´ì˜¨ <code>key</code>ë“¤ì— ëŒ€í•œ ìš”ì²­ì„ ëª¨ì•„ì„œ í•˜ë‚˜ì˜ ìš”ì²­ì„ ë§Œë“¤ì–´ DBì— queryí•˜ê³  ê·¸ ê²°ê³¼ë¥¼ ìš”ì²­ì˜¨ keyì— ë§ê²Œ mapping í•œë‹¤.<br>(ì´ ì˜ˆì œì—ì„œëŠ” í¸ì˜ìƒ memoryìƒì— dataë¥¼ í™œìš©í•˜ì˜€ë‹¤.)</p>
<p><code>setTimeout</code>ì€ event-loop ìƒì— í•˜ë‚˜ì˜ tick ì—ì„œ ì‹¤í–‰ë˜ì§€ ì•Šê³  ë‹¤ìŒìœ¼ë¡œ ì‹¤í–‰ì„ ë¯¸ë£¨ê²Œ ëœë‹¤.</p>
<h3 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[1, 2]</span><br><span class="line">[3, 4]</span><br><span class="line"></span><br><span class="line">&#123; id: 1 ... &#125;</span><br><span class="line">&#123; id: 2 ... &#125;</span><br><span class="line">&#123; id: 3 ... &#125;</span><br><span class="line">&#123; id: 4 ... &#125;</span><br></pre></td></tr></table></figure>
<p>tick ì´ 2ë²ˆ ë°œìƒí–ˆê¸° ë•Œë¬¸ì— loadë¥¼ 4ë²ˆ í˜¸ì¶œí•˜ì—¬ë„ ì‹¤ì œìš”ì²­ì€ 2ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ”ê±¸ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<p>ì „ì²´ì ì¸ ë™ì‘ì„ ë‹¤ì‹œ ì •ë¦¬í•˜ë©´ <code>load</code> ë¥¼ ê°œë³„ì ìœ¼ë¡œ í˜¸ì¶œí•˜ì§€ë§Œ ì‹¤í–‰ë˜ëŠ” tick ë³„ë¡œ groupingí•´ì„œ batch ìš”ì²­ì„ í•˜ê²Œë˜ê³  ê·¸ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ê°œë³„ì ìœ¼ë¡œ ë‚˜ëˆ ì„œ ë°˜í™˜í•˜ê²Œ ëœë‹¤.<br>ì¦‰, ë°ì´í„°ë¥¼ lazy loadingí•˜ë©´ì„œ ì„±ëŠ¥ì €í•˜ì˜ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆë‹¤.</p>
<h2 id="GraphQLì—-DataLoader-ì ìš©"><a href="#GraphQLì—-DataLoader-ì ìš©" class="headerlink" title="GraphQLì— DataLoader ì ìš©"></a>GraphQLì— DataLoader ì ìš©</h2><p>ì•„ê¹Œ ë¬¸ì œê°€ ë˜ì—ˆë˜ resolverì— DataLoaderë¥¼ ì ìš©í•´ë³´ì.<br>comments ì—ì„œ dataë¥¼ fetchingí•˜ëŠ” ë¶€ë¶„ì— DataLoaderë¥¼ ì ìš©í•´ì„œ í•´ê²°í•  ìˆ˜ ìˆë‹¤.</p>
<p>GraphQL ì—ì„œ DataLoaderë¥¼ ì ìš©í•˜ëŠ” ìˆœì„œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>
<ol>
<li>loadí•  dataì— ë”°ë¼ <code>batchLoadFn</code> ë¥¼ ì‘ì„±í•œë‹¤.</li>
<li>Contextì—ì„œ í•´ë‹¹ DataLoader ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.</li>
<li>resolverì—ì„œ contextì˜ DataLoaderë¥¼ í†µí•´ì„œ <code>load</code>ë¥¼ í˜¸ì¶œí•œë‹¤.</li>
</ol>
<p>DataLoaderì˜ instanceëŠ” ìì²´ì ìœ¼ë¡œ <code>cacheMap</code> ì„ ê°€ì§€ê³  ìˆë‹¤. ê°™ì€ keyì— ëŒ€í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ cachingëœ ê°’ì„ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë° web applicationì—ì„œ ì´ëŸ°ë°©ì‹ì€ ìœ„í—˜í•  ìˆ˜ ìˆë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ ë§¤ requestë§ˆë‹¤ ìƒˆë¡œìš´ DataLoader ê°ì²´ë¥¼ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ëŠ”ê²ƒì„ ê¶Œì¥í•˜ê³  ìˆë‹¤.</p>
<p><code>CommentsLoader</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> batchLoadFn = <span class="keyword">async</span> (postIds) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> comments = <span class="keyword">await</span> Comment.find(&#123; <span class="attr">where</span>: &#123; <span class="attr">postId</span>: In(postIds) &#125; &#125;)</span><br><span class="line">  <span class="keyword">return</span> postIds.map(<span class="function"><span class="params">id</span> =&gt;</span> comments.filter(<span class="function"><span class="params">c</span> =&gt;</span> c.postId === id))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> commentsLoader = <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> DataLoader(batchLoadFn)</span><br></pre></td></tr></table></figure></p>
<p><code>Context</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> ApolloServer(&#123;</span><br><span class="line">  ...,</span><br><span class="line">  context: <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    loaders: &#123;</span><br><span class="line">      commentsLoader: commentsLoader()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p><code>Resolver</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">comments: <span class="keyword">async</span> (root, _, context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> context.loaders.commentsLoader.load(root.id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ìœ„ì™€ê°™ì´ DataLoaderë¥¼ ì ìš©í•˜ë©´ comments resolverì—ì„œì˜ ëª¨ë“  load ìš”ì²­ì€ í•˜ë‚˜ì˜ ìš”ì²­ìœ¼ë¡œ ë¬¶ì—¬ì„œ ì‹¤í–‰ë˜ì„œ ì„±ëŠ¥ë¬¸ì œê°€ í•´ê²°ëœë‹¤. ë˜í•œ dataë¥¼ ì´ˆê¸°ì— ëª¨ë‘ fetchí•˜ì§€ ì•Šê³  lazyí•˜ê²Œ ìœ ì§€í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì—­í• ì— ë§ê²Œ resolverë¥¼ ë¶„ë¦¬í•´ì„œ ë³µì¡ì„±ì„ ì¤„ì¼ ìˆ˜ ìˆë‹¤.</p>
<h2 id="ë§ˆì¹˜ë©°"><a href="#ë§ˆì¹˜ë©°" class="headerlink" title="ë§ˆì¹˜ë©°"></a>ë§ˆì¹˜ë©°</h2><p>DataLoaderë¥¼ ì ìš©í•˜ëŠ” ê²ƒì€ í° ì–´ë ¤ì›€ì´ ì—†ì—ˆë˜ ê²ƒ ê°™ë‹¤. ì²˜ìŒì—” ë™ì‘ë°©ì‹ì´ ì¢€ ë‚œí•´í•˜ê²Œ ëŠê»´ì¡ŒëŠ”ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì½”ë“œë¥¼ ì½ê³ ë‚˜ì„œ ë³´ë‹ˆ Promiseì˜ ì´ì ê³¼ event-loopì˜ íŠ¹ì„±ì„ ì´ìš©í•˜ëŠ” ë¶€ë¶„ì´ ì¸ìƒì ì´ì˜€ë‹¤.</p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ul>
<li><a href="https://github.com/graphql/dataloader" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/graphql/dataloader</a></li>
<li><a href="https://medium.com/gaplabs-engineering/make-more-efficient-requests-with-dataloader-96ff50eb8998" rel="external nofollow noopener noreferrer" target="_blank">https://medium.com/gaplabs-engineering/make-more-efficient-requests-with-dataloader-96ff50eb8998</a></li>
<li><a href="https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/" rel="external nofollow noopener noreferrer" target="_blank">https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/</a></li>
<li><a href="https://engineering.shopify.com/blogs/engineering/solving-the-n-1-problem-for-graphql-through-batching" rel="external nofollow noopener noreferrer" target="_blank">https://engineering.shopify.com/blogs/engineering/solving-the-n-1-problem-for-graphql-through-batching</a></li>
<li><a href="https://github.com/typeorm/typeorm/blob/master/docs/eager-and-lazy-relations.md" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/typeorm/typeorm/blob/master/docs/eager-and-lazy-relations.md</a></li>
</ul>
</div><div class="article__author" itemscope="" itemprop="author" itemtype="https://schema.org/Person"><img class="article__author__image" src="/images/profile.jpg" alt="hosung"><a class="article__author__link" title="About hosung" rel="author">hosung</a><p class="article__author__desc">ğŸ”¥ Typescript</p><div class="article__author__socials"><a class="article__author__socials__item" href="http://github.com/y0c" title="github" target="_blank" rel="external nofollow noopener noreferrer"><i class="fa fa-github"></i></a><a class="article__author__socials__item" href="/feed.xml" title="rss" target="_blank"><i class="fa fa-rss"></i></a></div><meta itemprop="name" content="hosung"></div><div class="sharer" id="sharer"><div class="sharer-inner"><div class="sharer__right"><button class="sharer__item" id="sharer-facebook"><i class="fa fa-facebook-official"></i></button><button class="sharer__item" id="sharer-twitter"><i class="fa fa-twitter"></i></button><button class="sharer__item" id="sharer-pinterest"><i class="fa fa-pinterest"></i></button><button class="sharer__item" id="sharer-pocket"><i class="fa fa-get-pocket"></i></button></div></div></div><!-- Disqus Code--><div id="disqus_thread"></div><script>(function() {
  var d = document, s = d.createElement('script');
  s.src = '//lazy-developer.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();</script><noscript>Enable JavaScript to see comments.</noscript><!-- Meta Tags for Structured Data--><meta itemprop="dateModified" content="2019-11-24T14:39:33.303Z"><meta itemprop="articleBody" content="ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” GraphQL ì—ì„œ N+1 ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì†”ë£¨ì…˜ì¸ DataLoaderì— ëŒ€í•œ ì†Œê°œì™€ GraphQL ì— DataLoaderë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ ì ìš©í•´ì•¼ë˜ëŠ”ì§€ë¥¼ ì •ë¦¬í•´ë³´ë ¤ê³  í•œë‹¤.
N+1 ë¬¸ì œN+1 ë¬¸ì œëŠ” ORMì„ ì‚¬ìš©í• ë•Œ ì£¼ë¡œ ë°œìƒí•˜ëŠ” ì„±ëŠ¥ ë¬¸ì œì´ë‹¤.
Post ì—”í‹°í‹°ì™€ Comment ì—”í‹°í‹°ê°€ ìˆë‹¤ê³  ê°€ì •í•´ë³´ì. ì´ ì—”í‹°í‹°ê°„ì˜ ê´€ê³„ëŠ”..."><meta itemprop="url" content="https://y0c.github.io/2019/11/24/graphql-query-optimize-with-dataloader/"><meta itemprop="mainEntityOfPage" content="https://y0c.github.io/2019/11/24/graphql-query-optimize-with-dataloader/"><div itemscope="" itemtype="https://schema.org/Organization" itemprop="publisher"><meta itemprop="name" content="y0c"><div itemscope="" itemprop="logo" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://y0c.github.io/images/logo.png"></div></div><div itemscope="" itemtype="https://schema.org/ImageObject" itemprop="image"><meta itemprop="contentUrl" content="https://y0c.github.io/images/"><meta itemprop="url" content="https://y0c.github.io/images/"><meta itemprop="width"><meta itemprop="height"></div></article><section class="related-posts"><h3>Related posts</h3><div class="related-posts__item__wrapper"><a class="related-posts__item" href="/2019/11/17/graphql-data-mocking/"><div class="related-posts__item__background" style="background-image:url('/images/graphql-mock-data.jpg');"></div><div class="related-posts__item__overlay"></div><span class="related-posts__item__title">GraphQL Data Mocking</span></a></div></section></div></div></div><footer id="footer"><div class="widgets"><div class="widgets-inner"><!-- Jade doesn't support dynamic inclusion with `each`.--><!-- So, I just hard coded the file names that will be included.--><div class="widgets__item"><h3 class="widgets__item__heading">Recent posts</h3><ul class="recent-posts"><li class="recent-posts__item"><a href="/2019/11/24/graphql-query-optimize-with-dataloader/">GrpahQL DataLoaderë¥¼ ì´ìš©í•œ ì„±ëŠ¥ ìµœì í™”</a></li><li class="recent-posts__item"><a href="/2019/11/17/graphql-data-mocking/">GraphQL Data Mocking</a></li><li class="recent-posts__item"><a href="/2019/08/25/go-lambda-develop-notify-service/">Golangê³¼ Lambdaë¥¼ í™œìš©í•œ ì•Œë¦¼ ì„œë¹„ìŠ¤ ê°œë°œê¸°</a></li><li class="recent-posts__item"><a href="/2019/08/11/beginning-go/">TDDë¡œ Golang ì‹œì‘í•˜ê¸°</a></li><li class="recent-posts__item"><a href="/2019/07/14/vim-config-for-js-developer/">Vim Configuration ì •ë¦¬</a></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Archives</h3><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">2</span></li></ul></div><div class="widgets__item"><h3 class="widgets__item__heading">Categories</h3><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Javascript/">Javascript</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tmux/">Tmux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/graphql/">graphql</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/serverless/">serverless</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vim/">vim</a><span class="category-list-count">1</span></li></ul></div></div></div><p class="copyright"><small>Â© 2019 hosung<br>Powered by <a href="https://hexo.io" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a>, Theme by <a href="https://github.com/hyunseob" rel="external nofollow noopener noreferrer" target="_blank">HyunSeob</a></small></p></footer><script src="/js/sharer.min.js"></script></body></html>